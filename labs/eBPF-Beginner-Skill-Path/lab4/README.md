# Lab 4 — eBPF Verifier (success vs. failure paths)

Implements the iximiuz tutorial “eBPF Verifier” (<https://labs.iximiuz.com/tutorials/ebpf-verifier-3bd2e199>). The kernel program mirrors the execve counter from earlier labs and includes an optional unsafe path to demonstrate verifier rejection.

## Files
- `hello.c` — kernel program; compile with or without `-DTRIGGER_VERIFIER_FAIL`.
- `main.go` — user-space loader attaching to `sys_enter_execve`.
- `go.mod` — module definition.
- `vmlinux.h` — generated header (not committed; see below).
- `hello_bpf.*` — generated by `bpf2go` (not committed).

## Prereqs
- Go >= 1.22
- `clang` / `llc`
- `bpftool`
- Kernel with BTF (`/sys/kernel/btf/vmlinux`)

## One-time: generate `vmlinux.h`
```bash
bpftool btf dump file /sys/kernel/btf/vmlinux format c > vmlinux.h
```

## Build the safe variant (default)
```bash
go generate ./...   # runs bpf2go on hello.c
go build ./...      # produces ./lab4 binary
```

## Run the safe variant
```bash
sudo ./lab4
```

In another terminal:
```bash
sudo cat /sys/kernel/debug/tracing/trace_pipe
```

## Observe verifier success/failure manually
Build an object that should fail verification (null dereference) and view the log:
```bash
clang -g -O2 -target bpf -DTRIGGER_VERIFIER_FAIL -c hello.c -o hello_fail.bpf.o
sudo bpftool prog load hello_fail.bpf.o /sys/fs/bpf/hello_fail --verifier --log
```
The load should fail with a verifier log explaining the unsafe dereference.

You can also view verifier output for the safe object:
```bash
clang -g -O2 -target bpf -c hello.c -o hello_ok.bpf.o
sudo bpftool prog load hello_ok.bpf.o /sys/fs/bpf/hello_ok --verifier --log
sudo bpftool prog show id $(sudo bpftool prog list | awk '/hello_ok/ {print $1}' | tr -d :)
```

## Cleanup
```bash
sudo pkill lab4 || true
sudo rm -f /sys/fs/bpf/hello_fail /sys/fs/bpf/hello_ok 2>/dev/null || true
```

